# SEH Based Buffer Overflow

The purpose of this lab is to familiarize how Structured Exception Handler / SEH based buffer overflow exploits work.

This lab is based on a blog post [The Basics of Exploit Development 2: SEH Overflows](https://www.coalfire.com/the-coalfire-blog/march-2020/the-basics-of-exploit-development-2-seh-overflows) by Andy Bowden.

{% hint style="info" %}
WIP
{% endhint %}

## SEH 101

* Structured exception handling \(SEH\) is simply code in a program that is meant to handles such situations when the program throws some exception either due to a hardware or software issue and do something to resolve it;
* SEH code is located on the program's stack for each `try-catch` code block and each handler has its own stack frame;
* SEH is stored in stack as `EXCEPTION_REGISTRATION` structure \(also called as SEH record\) consisting of two 4 byte fields:
  * pointer to the next SEH record within the SEH chain;
  * pointer to the exception handler code - the `catch` part of the code block;
* A program may have multiple SEHs registered that are connected by a linked list, forming a SEH chain;
  * Once a program throws an exception, the OS runs through the SEH chain and attempts to find an apropriate exception handler. If no suitable handler is found, a default OS handler is used from the bottom of the SEH chain;
* All SEH chains always end with a default Windows SEH record located at `FFFFFFFF`;
* SEH chain is stored in the Thread Environment Block \(TEB\) memory structure as the first member called Thread Information Block \(TIB\) and can be accessed via FS segment register `FS:[0x00]`;

Below is a diagram showing:



## How does SEH look?

SEH are the `try` / `catch` code blocks as shown below:

```c
int main(int argc, char* argv[]) 
{
    try
    {
        throw 1;
    }
    catch (int e)
    {
        
    }

    return 0;
}
```

If we compile the above code and run it in xdgb32 debugger, we can see...

## References

{% embed url="https://www.corelan.be/index.php/2009/07/25/writing-buffer-overflow-exploits-a-quick-and-basic-tutorial-part-3-seh/" %}



