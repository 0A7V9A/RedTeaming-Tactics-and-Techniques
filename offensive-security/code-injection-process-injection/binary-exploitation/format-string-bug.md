# Format String Bug

This is a quick lab to familiarize with the format string bugs and see how they can be abused. It's based on the [Shellcoder's Handbook](https://www.wiley.com/en-gb/The+Shellcoder%27s+Handbook%3A+Discovering+and+Exploiting+Security+Holes%2C+2nd+Edition-p-9780470080238) and the code sample that comes with it.

{% hint style="info" %}
WIP
{% endhint %}

## Overview

Format String bug appears in programs written in C, which means this bug is applicable to all operating systems that have a C compiler, or in other words - most of OSes.

### What is Format String?

> **printf format string** refers to a control parameter used by a class of [functions](https://en.wikipedia.org/wiki/Function_%28computer_science%29) in the input/output libraries of [C](https://en.wikipedia.org/wiki/C_%28programming_language%29) and many other [programming languages](https://en.wikipedia.org/wiki/Programming_languages). The string is written in a simple [template language](https://en.wikipedia.org/wiki/Template_language): characters are usually copied literally into the function's output, but **format specifiers**, which start with a [`%`](https://en.wikipedia.org/wiki/Percent_sign) character, indicate the location and method to translate a piece of data \(such as a number\) to characters.  
> [  
> https://en.wikipedia.org/wiki/Printf\_format\_string](https://en.wikipedia.org/wiki/Printf_format_string)

In other words, format string allows the programmer to specify how a certain value, say a floating-point number such as money savings, should be printed to the screen.

Let's look at the below code example, where the `savings` variable is defined as a floating value of `345.82`, which is printed to the screen with `printf`, using the format string `Savings: $%f`:

{% hint style="info" %}
The `%f` in the format string tells the `printf()` to print the value of `savings` as a floating-point value.
{% endhint %}

{% code title="fmt-00.c" %}
```c
#include <stdio.h>
#include <stdlib.h>

int main( int argc, char *argv[] )
{
        double savings = 345.82;
        
        // The first argument is the format string.
        // It tells printf to print the value of savings as a floating value.
        printf("Savings: $%f", savings);
        return 0;
}

```
{% endcode %}

Let's compile and run the code and observe the result:

```text
gcc .\fmt-00.c -o fmt-00.exe; .\fmt-00.exe
```

...we can see that the `savings` value was printed with 6 decimal places:

![](../../../.gitbook/assets/image%20%281075%29.png)

However, `$345.820000` is not the precision we need when dealing with money, so it would look better if the value only had 2 decimal places, such as `$345.82`. With the help of format string `Savings: $%.2f`, we can achieve exactly that:

![](../../../.gitbook/assets/image%20%281077%29.png)

### What is Format String Bug?

Programs become vulnerable to the format string bug when user supplied data is included in the format string the program uses to display the data when using print functions such as \(not limited to\):

```c
printf
fprintf
sprintf
snprintf
...
```

Let's look at the sample code provided below, that takes in the user supplied argument 1 and uses it in inside the function `printf`, which means that the user's supplied string to the program is used as a format string. 

{% code title="fmt.c" %}
```c
#include <stdio.h>
#include <stdlib.h>

int main( int argc, char *argv[] )
{
        if( argc != 2 )
        {
                printf("Error - supply a format string please\n");
                return 1;
        }

        printf( argv[1] );
        printf( "\n" );

        return 0;
}
```
{% endcode %}

Let's compile and run the program without feeding it any strings first:

```text
gcc .\fmt.c -o fmt.exe; .\fmt.exe
```

![](../../../.gitbook/assets/image%20%281081%29.png)

Let's now supply a string format, say `Testing: 0x%x`:

```text
gcc .\fmt.c -o fmt.exe; .\fmt.exe "Testing: 0x%x"
```

![](../../../.gitbook/assets/image%20%281078%29.png)

Considering the fact that the format string is supplied, but the corresponding variable is not \(which would be provided in the program written by a programmer, however in our case we are supplying the format string to the program via a commandline argument without associated variables\), the program simply **starts reading values from the stack memory**.

There is nothing preventing us from reading multiple values from the stack too:

```text
gcc .\fmt.c -o fmt.exe; .\fmt.exe "Reading stack memory: 0x%x 0x%x 0x%x 0x%x"
```

![](../../../.gitbook/assets/image%20%281080%29.png)

       

## References

{% embed url="https://www.wiley.com/en-gb/The+Shellcoder%27s+Handbook%3A+Discovering+and+Exploiting+Security+Holes%2C+2nd+Edition-p-9780470080238" %}

[https://www.exploit-db.com/docs/english/28476-linux-format-string-exploitation.pdf](https://www.exploit-db.com/docs/english/28476-linux-format-string-exploitation.pdf)

